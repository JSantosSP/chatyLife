rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Reglas para usuarios
    match /users/{userId} {
      // Usuarios solo pueden leer y escribir su propio perfil
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Permitir búsqueda de usuarios (solo lectura de campos públicos)
      allow read: if request.auth != null;
    }

    // Reglas para contactos
    match /contacts/{contactId} {
      // Solo el dueño del contacto puede leerlo
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      
      // Solo el usuario autenticado puede crear sus propios contactos
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      
      // No se permiten actualizaciones ni eliminaciones
      allow update, delete: if false;
    }

    // Reglas para chats
    match /chats/{chatId} {
      // Permitir lectura si el usuario es participante
      // Para consultas, permitir si el where clause filtra por participant1Id o participant2Id
      allow read: if request.auth != null && 
                     (resource == null || 
                      resource.data.participant1Id == request.auth.uid ||
                      resource.data.participant2Id == request.auth.uid);
      
      // Solo los participantes pueden crear/actualizar el chat
      allow create: if request.auth != null && 
                       (request.resource.data.participant1Id == request.auth.uid ||
                        request.resource.data.participant2Id == request.auth.uid);
      
      // Permitir actualización si el usuario es participante
      allow update: if request.auth != null && 
                       (resource.data.participant1Id == request.auth.uid ||
                        resource.data.participant2Id == request.auth.uid);
      
      // Reglas para mensajes dentro de un chat
      match /messages/{messageId} {
        // Permitir lectura si el usuario puede leer el chat padre
        allow read: if request.auth != null && 
                       (get(/databases/$(database)/documents/chats/$(chatId)).data.participant1Id == request.auth.uid ||
                        get(/databases/$(database)/documents/chats/$(chatId)).data.participant2Id == request.auth.uid);
        
        // Solo el remitente puede crear mensajes y debe ser participante del chat
        allow create: if request.auth != null && 
                         request.resource.data.senderId == request.auth.uid &&
                         (get(/databases/$(database)/documents/chats/$(chatId)).data.participant1Id == request.auth.uid ||
                          get(/databases/$(database)/documents/chats/$(chatId)).data.participant2Id == request.auth.uid);
        
        // El remitente puede actualizar sus mensajes (marcar como leído)
        // El receptor puede actualizar el mensaje para marcar imagen como descargada
        allow update: if request.auth != null && 
                         (resource.data.senderId == request.auth.uid ||
                          // Permitir que el receptor actualice si es participante del chat
                          (resource.data.receiverId == request.auth.uid &&
                           (get(/databases/$(database)/documents/chats/$(chatId)).data.participant1Id == request.auth.uid ||
                            get(/databases/$(database)/documents/chats/$(chatId)).data.participant2Id == request.auth.uid)));
      }
    }

    // Reglas para activeChats (rastreo de usuarios activos en chats)
    match /activeChats/{userId} {
      // Solo el usuario puede leer y escribir sus propios activeChats
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Reglas para los chats dentro de activeChats
      match /chats/{chatId} {
        // Solo el usuario puede leer y escribir sus propios chats activos
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}



